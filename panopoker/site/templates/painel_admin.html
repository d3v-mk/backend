<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark" />
  <title>Painel Admin - Promotores</title>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }

    h1, h2 {
      text-align: center;
    }

    input[type="text"], input[type="number"], select {
    width: 250px;
    margin: 0 auto 20px auto;
    display: block;
    padding: 8px;
    border-radius: 6px;
    border: none;
    background-color: #333;
    color: white;
    font-size: 0.95em;
    }


    .exportar {
      display: block;
      text-align: center;
      margin-bottom: 20px;
    }

    .exportar a {
      text-decoration: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 40px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #444;
      text-align: left;
      font-size: 0.95em;
    }

    th {
      background-color: #222;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .botao {
      background-color: #FFD700;
      color: black;
      font-weight: bold;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      width: 110px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .botao-danger {
      background-color: #c0392b;
      color: white;
    }

    .botao[disabled] {
      background-color: gray;
      cursor: not-allowed;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #1e1e1e;
      width: 180px;
      border-radius: 6px;
      box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.3);
      z-index: 999;
      padding: 6px 0;
      white-space: nowrap;
    }

    .dropdown-content form {
      margin: 0;
    }

    .dropdown-content button {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      color: white;
      padding: 10px;
      font-size: 0.9em;
      cursor: pointer;
    }

    .dropdown-content button:hover {
      background-color: #333;
    }

    .dropdown.show .dropdown-content {
      display: block;
    }

    .tooltip {
      text-decoration: underline dotted;
      cursor: help;
    }

    .form-promover {
      background-color: #1e1e1e;
      border-left: 4px solid #00bfff;
      border-radius: 10px;
      padding: 20px;
      margin: 30px auto;
      max-width: 500px;
      box-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
    }

    .card-form {
      background-color: #151515;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.05);
    }

    .card-form h3 {
      margin-top: 0;
      color: gold;
      font-size: 1.2em;
    }

    .form-promover input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 20px;
      border-radius: 6px;
      border: none;
      background-color: #333;
      color: white;
      font-size: 1em;
    }
    

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
        width: 100%;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 15px;
        border: 1px solid #444;
        border-radius: 10px;
        padding: 10px;
        background-color: #1a1a1a;
      }

      td {
        border: none;
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
      }

      td::before {
        content: attr(data-label);
        font-weight: bold;
        flex: 1;
        color: #999;
      }
    }
  </style>
</head>
<body>
  <h1>Painel Administrativo - Promotores</h1>

  <div class="exportar">
    <a href="/admin/promotores/exportar" class="botao">üìÑ Exportar CSV</a>
  </div>

  <h2>üïπÔ∏è Jogadores Online por Mesa</h2>
  <div id="contador-jogadores">
    <p>Carregando jogadores online...</p>
  </div>

  <h2>Gerenciar Cargo de Promotor</h2>
  <div class="form-promover">
    <div class="card-form">
      <h3>‚öôÔ∏è Gerenciar Cargo</h3>
      <form id="form-promotor" method="post" action="/admin/usuario/promover/0" onsubmit="return definirAcao(this)">
        <label for="user_id_geral">üÜî ID do Usu√°rio:</label>
        <input type="number" id="user_id_geral" name="user_id" required placeholder="Ex: 42" />
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button type="submit" class="botao" onclick="setAcao('promover')">‚úÖ Promover</button>
          <button type="submit" class="botao botao-danger" onclick="setAcao('despromover')">‚ùå Remover</button>
        </div>
      </form>
    </div>
  </div>


  <h2>Manuten√ß√£o do Sistema</h2>
  <div class="form-promover">
    <div class="card-form">
      <h3>üõ†Ô∏è Ativar Manuten√ß√£o</h3>
      <form id="form-manutencao" method="post" action="/admin/ativar-manutencao" onsubmit="return confirmarAtivarManutencao();">
        <p>
          Essa a√ß√£o vai colocar as mesas em manuten√ß√£o.<br />
          Mesas em jogo ter√£o manuten√ß√£o na pr√≥xima rodada.<br />
          Mesas abertas entram em manuten√ß√£o imediata.
        </p>
        <div style="text-align: center;">
          <button type="submit" class="botao botao-danger">‚ö†Ô∏è Ativar Manuten√ß√£o</button>
        </div>
      </form>
    </div>
  </div>

  <h2>Manuten√ß√£o do Sistema</h2>
  <div class="form-promover">
    <div class="card-form">
      <h3>üõ†Ô∏è Encerrar Manuten√ß√£o</h3>
      <form id="form-encerrar-manutencao" method="post" action="/admin/encerrar-manutencao" onsubmit="return confirmarEncerrarManutencao();">
        <p>
          Essa a√ß√£o vai reabrir as mesas que est√£o em manuten√ß√£o.<br />
          Mesas em manuten√ß√£o ter√£o status alterado para "aberta".
        </p>
        <div style="text-align: center;">
          <button type="submit" class="botao botao-danger">‚úÖ Encerrar Manuten√ß√£o</button>
        </div>
      </form>
    </div>
  </div>

  <h2>üì¢ Criar Not√≠cia Admin</h2>
  <div class="form-promover">
    <div class="card-form">
      <h3>üìù Nova Not√≠cia</h3>
      <form id="form-noticia-admin" method="post" action="/criar/noticias/admin" onsubmit="return validarNoticiaAdmin();">
        <label for="mensagem">Mensagem:</label>
        <textarea id="mensagem" name="mensagem" rows="4" required
          placeholder="Escreva a not√≠cia aqui..." style="width: 100%; padding: 10px; border-radius: 6px; border: none; background-color: #333; color: white; font-size: 1em;"></textarea>
        <div style="text-align: center; margin-top: 15px;">
          <button type="submit" class="botao">üöÄ Publicar</button>
        </div>
      </form>
    </div>
  </div>


  <h2>üßπ Limpar Not√≠cias</h2>
  <div class="form-promover">
    <div class="card-form">
      <h3>‚ö†Ô∏è Apagar todas as not√≠cias</h3>
      <p style="color: #f39c12; text-align:center; margin-bottom: 20px;">
        Isso vai apagar <strong>todas</strong> as not√≠cias e resetar os IDs.<br>
        <strong>N√£o tem volta!</strong>
      </p>
      <div style="text-align: center;">
        <button id="btn-limpar-noticias" class="botao botao-danger" style="width: 180px;">üóëÔ∏è Apagar Tudo</button>
      </div>
    </div>
  </div>


  <input type="text" id="filtro" onkeyup="filtrarPromotores()" placeholder="üîç Buscar por nome, ID ou slug..." />

  <select onchange="filtrarPorStatus(this.value)">
    <option value="">Todos</option>
    <option value="liberado">Liberados</option>
    <option value="bloqueado">Bloqueados</option>
  </select>

  <table id="tabela-promotores">
    <thead>
      <tr>
        <th>Nome</th>
        <th>ID</th>
        <th>Slug</th>
        <th>Access Token</th>
        <th>Saldo</th>
        <th>Status</th>
        <th>√öltima Atividade</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for promotor in promotores %}
      <tr>
        <td data-label="Nome">{{ promotor.nome }}</td>
        <td data-label="ID">
          {{ promotor.id }}
          <button onclick="copiarId('{{ promotor.id }}')">üìã</button>
        </td>
        <td data-label="Slug">{{ promotor.slug }}</td>
        <td data-label="Access Token">
        {% if promotor.access_token %}
            ‚úÖ
        {% else %}
            ‚ùå
        {% endif %}
        </td>
        <td data-label="Saldo a Repassar">R$ {{ promotor.saldo_repassar }}</td>
        <td data-label="Status">
          {% if promotor.bloqueado %}
          <span class="tooltip" title="Este promotor est√° bloqueado." style="color: red;">Bloqueado</span>
          {% else %}
          <span class="tooltip" title="Este promotor est√° liberado." style="color: #0f0;">Liberado</span>
          {% endif %}
        </td>
        <td data-label="√öltima Atividade">
          {{ promotor.ultima_atividade or '‚è≥ Sem atividade recente' }}
        </td>
        <td data-label="A√ß√µes">
          <div class="dropdown" id="dropdown-{{ promotor.id }}">
            <button class="botao" onclick="toggleDropdown(event, 'dropdown-{{ promotor.id }}')">A√ß√µes ‚ñº</button>
            <div class="dropdown-content">
              <form method="post" action="/admin/promotor/{{ promotor.id }}/desbloquear">
                <button type="submit" {% if not promotor.bloqueado %}disabled{% endif %}>Desbloquear ‚úÖ</button>
              </form>
              <form method="post" action="/admin/promotor/{{ promotor.id }}/zerar_saldo" onsubmit="return confirmarZerar();">
                <button class="botao-danger" type="submit">Zerar Saldo 0Ô∏è‚É£</button>
              </form>
              {% if promotor.slug %}
              <form method="post" action="/admin/promotor/{{ promotor.id }}/apagar_loja" onsubmit="return confirm('Tem certeza que deseja apagar a loja deste promotor? Esta a√ß√£o n√£o poder√° ser desfeita.');">
                <button class="botao-danger" type="submit">Apagar Loja üóëÔ∏è</button>
              </form>
              {% endif %}
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    let acaoSelecionada = "promover";

    function setAcao(tipo) {
      acaoSelecionada = tipo;
    }

    function confirmarAtivarManutencao() {
      return confirm('Confirma ativar manuten√ß√£o para as mesas?');
    }

    function confirmarEncerrarManutencao() {
      return confirm('Tem certeza que deseja encerrar a manuten√ß√£o e reabrir as mesas?');
    }

    // limpar noticias admin
    document.getElementById('btn-limpar-noticias').addEventListener('click', async (e) => {
      e.preventDefault();
      if (!confirm("Voc√™ tem certeza que quer apagar todas as not√≠cias? Esta a√ß√£o n√£o pode ser desfeita.")) {
        return;
      }
      try {
        const res = await fetch('/noticias/limpar', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (!res.ok) throw new Error('Erro ao apagar not√≠cias');
        const data = await res.json();
        alert(data.msg);
      } catch (err) {
        alert(err.message);
      }
    });
    // fim do limpar noticias admin

    // Criar noticias admin
    const form = document.getElementById('form-noticia-admin');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mensagem = form.mensagem.value.trim();
      if (!mensagem) {
        alert('Escreva a mensagem da not√≠cia.');
        return;
      }

      try {
        const res = await fetch('/criar/noticias/admin', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mensagem })
        });
        if (!res.ok) throw new Error('Erro ao criar not√≠cia');
        alert('Not√≠cia criada com sucesso!');
        form.reset();
      } catch (err) {
        alert(err.message);
      }
    });
    // Fim Criar noticias admin

    function definirAcao(form) {
      const id = form.querySelector('input[name="user_id"]').value;
      if (!id) return false;

      form.action = `/admin/usuario/${acaoSelecionada}/${id}?tipo=promotor`;
      return true;
    }

    function filtrarPromotores() {
      const filtro = document.getElementById("filtro").value.toLowerCase();
      const linhas = document.querySelectorAll("#tabela-promotores tbody tr");
      linhas.forEach(row => {
        const texto = row.innerText.toLowerCase();
        row.style.display = texto.includes(filtro) ? "" : "none";
      });
    }

    function filtrarPorStatus(valor) {
      const linhas = document.querySelectorAll("#tabela-promotores tbody tr");
      linhas.forEach(row => {
        const statusText = row.querySelector("td[data-label='Status']").innerText.toLowerCase();
        row.style.display = (!valor || statusText.includes(valor)) ? "" : "none";
      });
    }

    function copiarId(id) {
      navigator.clipboard.writeText(id);
      alert("ID copiado: " + id);
    }

    function confirmarZerar() {
      return confirm("Tem certeza que deseja zerar o saldo deste promotor?");
    }

    function toggleDropdown(event, id) {
      event.stopPropagation();
      document.querySelectorAll(".dropdown").forEach(el => el.classList.remove("show"));
      const dropdown = document.getElementById(id);
      if (dropdown) dropdown.classList.toggle("show");
    }

    window.addEventListener("click", () => {
      document.querySelectorAll(".dropdown").forEach(el => el.classList.remove("show"));
    });



    // contador players online
    async function atualizarContadorJogadores() {
      try {
        const res = await fetch('/admin/mesas/ativos');
        if (!res.ok) throw new Error('Erro ao buscar dados');
        const dados = await res.json();

        const div = document.getElementById('contador-jogadores');
        div.innerHTML = '';  // limpa o conte√∫do

        if (Object.keys(dados).length === 0) {
          div.innerHTML = '<p>Nenhuma mesa com jogadores online agora.</p>';
          return;
        }

        // Cria uma lista simples das mesas com quantos jogadores online tem
        const ul = document.createElement('ul');
        for (const mesa_id in dados) {
          const jogadores = dados[mesa_id];
          const li = document.createElement('li');
          li.textContent = `Mesa ${mesa_id}: ${jogadores.length} jogador(es) online`;
          ul.appendChild(li);
        }
        div.appendChild(ul);

      } catch (error) {
        console.error('Erro ao atualizar contador:', error);
        const div = document.getElementById('contador-jogadores');
        div.innerHTML = '<p>Erro ao carregar dados dos jogadores.</p>';
      }
    }

    // Atualiza j√° ao carregar e depois a cada 10s (10000ms)
    atualizarContadorJogadores();
    setInterval(atualizarContadorJogadores, 10000);
    // fim contador players online
    
  </script>
</body>
</html>
