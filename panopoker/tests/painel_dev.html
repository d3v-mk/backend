<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PanoPoker Dev Panel</title>
  <style>
    body { font-family: sans-serif; background: #121212; color: #eee; padding: 20px; }
    .jogador {
      border: 1px solid #444;
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      background: #1e1e1e;
      width: 290px;
      flex-shrink: 0;
    }
    #jogadores {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    button {
      margin: 5px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #333;
      color: #fff;
      cursor: pointer;
    }
    button:hover { background: #555; }
    input[type="number"] { width: 60px; }
    .mesa { margin-bottom: 30px; }
    .vez { color: #00ff88; font-weight: bold; }
    .entradas { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>PanoPoker Painel Dev</h1>

  <div class="entradas">
    <label>Mesa ID: <input type="number" id="mesaId" value="1" /></label>
    <button onclick="carregarMesa()">üîÑ Carregar Mesa</button>
    <div style="margin-top: 10px;">
      <strong>Entrar na mesa:</strong><br/>
      <button onclick="entrarNaMesa(1)">üéÆ Jogador 1</button>
      <button onclick="entrarNaMesa(2)">üéÆ Jogador 2</button>
      <button onclick="entrarNaMesa(3)">üéÆ Jogador 3</button>
      <button onclick="entrarNaMesa(4)">üéÆ Jogador 4</button>
      <button onclick="entrarNaMesa(5)">üéÆ Jogador 5</button>
      <button onclick="entrarNaMesa(6)">üéÆ Jogador 6</button>
    </div>

    <div style="margin-top: 20px;">
      <strong>‚ö†Ô∏è Ferramentas Dev:</strong><br/>
      <button onclick="forcarShowdown()">üèÜ For√ßar Showdown</button>
    </div>
  </div>

  <div class="mesa" id="mesaInfo"></div>
  <div id="jogadores"></div>

  <script>
    const tokens = {
      1: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzQ3NDE2ODI0fQ.W9Krfv97Dwvid9ARUi_nmkVDYJmXCYuNhekI3vnf0Uk",
      2: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyIiwiZXhwIjoxNzQ3NDE2OTA1fQ.UZTcNLvwnzwYblT_wsfkwQYInGtxWR_wxBLPiXQnur0",
      3: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzIiwiZXhwIjoxNzQ3NDE2OTE4fQ.0iDttYik5EMotMsjzUPQE4LD6dlk2ZlRzd5tAnaV-qk",
      4: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI0IiwiZXhwIjoxNzQ3NDE2OTMxfQ.8D0GgPT0zXO-XXqt5Z2vm6uD11rTUnc2LShOGRaA1zc",
      5: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI1IiwiZXhwIjoxNzQ3NDE2OTQ0fQ.rblyPXk3vXLa9KTopq0vh5MfR683YebOs42zt31d8s0",
      6: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2IiwiZXhwIjoxNzQ3NDE2OTU4fQ.pBTEcyTcH-adFfFonyRgEXNE21gHsFJxQGcpsOWanEE"
    };

    async function carregarMesa() {
      const mesaId = document.getElementById("mesaId").value;
      const token = tokens[1];

      try {
        const mesaRes = await fetch(`http://localhost:8000/mesa/${mesaId}`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const mesa = await mesaRes.json();

        const jogadoresRes = await fetch(`http://localhost:8000/mesa/${mesaId}/jogadores`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const jogadores = await jogadoresRes.json();

        document.getElementById("mesaInfo").innerHTML = `
          <h2>Mesa ${mesa.id} ‚Äî Estado: ${mesa.estado_da_rodada}</h2>
          <p>Cartas comunit√°rias: ${JSON.stringify(mesa.cartas_comunitarias)}</p>
          <p>Pote: R$ ${mesa.pote_total}</p>
          <p>Jogador da vez: ${mesa.jogador_da_vez}</p>
        `;

        const container = document.getElementById("jogadores");
        container.innerHTML = "";
        jogadores.forEach(j => {
          const vezTag = j.vez ? `<span class="vez">‚óè VEZ</span>` : "";
          const sbTag = j.is_sb ? "üü¢ SB" : "";
          const bbTag = j.is_bb ? "üî¥ BB" : "";
          const dealerTag = j.posicao_cadeira === mesa.dealer_pos ? "‚ö™ DEALER" : "";

          const div = document.createElement("div");
          div.className = "jogador";
          div.innerHTML = `
            <h3>Jogador ${j.user_id} ‚Äî posi√ß√£o ${j.posicao_cadeira} ${vezTag}</h3>
            <p>Saldo atual: R$ ${j.saldo_atual}</p>
            <p>Aposta atual: R$ ${j.aposta_atual}</p>
            <p>Foldado: ${j.foldado}</p>
            <p>Agiu nesta rodada: ${j.rodada_ja_agiu}</p>
            <p>${sbTag} ${bbTag} ${dealerTag}</p>
            <p>Cartas: ${j.cartas?.join(", ")}</p>
            <button onclick="acao(${mesa.id}, ${j.user_id}, 'check')">Check</button>
            <button onclick="acao(${mesa.id}, ${j.user_id}, 'call')">Call</button>
            <button onclick="acao(${mesa.id}, ${j.user_id}, 'fold')">Fold</button>
            <button onclick="acao(${mesa.id}, ${j.user_id}, 'allin')">All-In</button>
            <br/>
            <label>Raise: R$ <input type="number" id="raise-${j.user_id}" value="0.05"/></label>
            <button onclick="acao(${mesa.id}, ${j.user_id}, 'raise')">Raise</button>
            <br/><br/>
            <button onclick="sairDaMesa(${mesa.id}, ${j.user_id})">üö™ Sair da Mesa</button>
            <button onclick="revelarCartas(${mesa.id}, ${j.user_id})">üÉè Revelar Cartas</button>

          `;
          container.appendChild(div);
        });

      } catch (err) {
        console.error("üí• Erro ao carregar mesa:", err);
        alert("Erro: " + err.message);
      }
    }

    async function revelarCartas(mesaId, jogadorId) {
      const token = tokens[jogadorId];
      if (!token) {
        alert(`Token do jogador ${jogadorId} n√£o encontrado.`);
        return;
      }

      try {
        const res = await fetch(`http://localhost:8000/mesa/${mesaId}/revelar_cartas`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        const data = await res.json();
        alert(`üÉè Jogador ${jogadorId} revelou suas cartas!\n${data.message || JSON.stringify(data)}`);
        carregarMesa();

      } catch (err) {
        console.error("Erro ao revelar cartas:", err);
        alert("Erro ao chamar /revelar_cartas: " + err.message);
      }
    }


    async function acao(mesaId, jogadorId, tipo) {
      let url = `http://localhost:8000/mesa/${mesaId}/${tipo}`;
      const token = tokens[jogadorId];
      let options = {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        }
      };

      // Se for raise, pega o valor e joga na query string
      if (tipo === "raise") {
        const input = document.getElementById(`raise-${jogadorId}`);
        if (!input) {
          alert("Campo de raise n√£o encontrado.");
          return;
        }
        const valor = parseFloat(input.value);
        if (isNaN(valor) || valor <= 0) {
          alert("Insira um valor v√°lido para o raise.");
          return;
        }
        url += `?valor=${valor}`;
        delete options.headers["Content-Type"]; // n√£o precisa de body
        delete options.body;
      }

      try {
        const res = await fetch(url, options);
        const data = await res.json();

        const msg = data.detail
          ? data.detail
          : JSON.stringify(data, null, 2);

        alert(`${tipo.toUpperCase()} (J${jogadorId}) ‚Üí\n${msg}`);
        carregarMesa();

      } catch (err) {
        console.error(`Erro ao fazer ${tipo}:`, err);
        alert("Erro: " + err.message);
      }
    }


    async function entrarNaMesa(jogadorId) {
      const mesaId = document.getElementById("mesaId").value;
      const token = tokens[jogadorId];
      if (!token) {
        alert(`Token do jogador ${jogadorId} n√£o encontrado.`);
        return;
      }

      try {
        const res = await fetch(`http://localhost:8000/mesa/${mesaId}/entrar`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        const data = await res.json();
        alert(`üéÆ JOGADOR ${jogadorId} entrou na mesa ‚Üí ${data.detail || "OK"}`);
        carregarMesa();

      } catch (err) {
        console.error("Erro ao entrar na mesa:", err);
        alert("Erro: " + err.message);
      }
    }

    async function sairDaMesa(mesaId, jogadorId) {
      const token = tokens[jogadorId];
      if (!token) {
        alert(`Token do jogador ${jogadorId} n√£o encontrado.`);
        return;
      }

      try {
        const res = await fetch(`http://localhost:8000/mesa/${mesaId}/sair`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        const data = await res.json();
        alert(`üö™ JOGADOR ${jogadorId} saiu da mesa ‚Üí ${data.detail || "OK"}`);
        carregarMesa();

      } catch (err) {
        console.error("Erro ao sair da mesa:", err);
        alert("Erro: " + err.message);
      }
    }

    async function forcarShowdown() {
    const mesaId = document.getElementById("mesaId").value;
    const token = tokens[1];

    try {
      const res = await fetch(`http://localhost:8000/admin/${mesaId}/debug/forcar_showdown`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token
        }
      });

      const data = await res.json();
      alert(`üèÜ Mesa ${mesaId} for√ßada para SHOWDOWN!\n${data.detail || "OK"}`);
      carregarMesa();

    } catch (err) {
      console.error("Erro ao for√ßar showdown:", err);
      alert("Erro ao chamar /debug/forcar_showdown: " + err.message);
    }
  }

  </script>
</body>
</html>
