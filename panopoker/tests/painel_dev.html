<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PanoPoker Dev Panel</title>
  <style>
    body { font-family: sans-serif; background: #121212; color: #eee; padding: 20px; }
    .jogador {
      border: 1px solid #444;
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      background: #1e1e1e;
      width: 290px;
      flex-shrink: 0;
    }
    #jogadores {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    button {
      margin: 5px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #333;
      color: #fff;
      cursor: pointer;
    }
    button:hover { background: #555; }
    input[type="number"] { width: 60px; }
    .mesa { margin-bottom: 30px; }
    .vez { color: #00ff88; font-weight: bold; }
    .entradas { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>PanoPoker Painel Dev (Full WebSocket)</h1>

  <div class="entradas">
    <label>Mesa ID: <input type="number" id="mesaId" value="1" /></label>
    <button onclick="carregarMesa()">ğŸ”„ Carregar Mesa</button>
    <div style="margin-top: 10px;">
      <strong>Entrar na mesa:</strong><br/>
      <button onclick="entrarNaMesaWs(1)">ğŸ® Jogador 1</button>
      <button onclick="entrarNaMesaWs(2)">ğŸ® Jogador 2</button>
      <button onclick="entrarNaMesaWs(3)">ğŸ® Jogador 3</button>
      <button onclick="entrarNaMesaWs(4)">ğŸ® Jogador 4</button>
      <button onclick="entrarNaMesaWs(5)">ğŸ® Jogador 5</button>
      <button onclick="entrarNaMesaWs(6)">ğŸ® Jogador 6</button>
    </div>

    <div style="margin-top: 20px;">
      <strong>âš ï¸ Ferramentas Dev:</strong><br/>
      <button onclick="forcarShowdown()">ğŸ† ForÃ§ar Showdown</button>
    </div>
  </div>

  <div class="mesa" id="mesaInfo"></div>
  <div id="jogadores"></div>

  <script>
    // TOKENS para autenticar jogadores
    const tokens = {
      1: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzQ4MTc5NTk2fQ.DIUoF6mymNv2a9Wa9nDA8FB0s4j7UXiqSO5SiaS67dg",
      2: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyIiwiZXhwIjoxNzQ4MTc5ODkyfQ.rHd79SASSAAfqb1qSXejZG68mF1CPv1jwnq_rLyF6yU",
      3: "TOKEN_JOGADOR_3",
      4: "TOKEN_JOGADOR_4",
      5: "TOKEN_JOGADOR_5",
      6: "TOKEN_JOGADOR_6"
    };

    // WS de painel (apenas para escutar/broadcast)
    let wsPainel = null;
    let wsMesaId = null;

    // FunÃ§Ã£o para conectar WS para entrar na mesa
    function entrarNaMesaWs(jogadorId) {
      const mesaId = document.getElementById("mesaId").value;
      const token = tokens[jogadorId];
      if (!token) return alert("Token nÃ£o encontrado!");

      // Cada jogador sÃ³ pode ter um WS ativo. Cria um novo WS dedicado pra entrar.
      const ws = new WebSocket(`ws://localhost:8000/ws/mesa/${mesaId}`);
      ws.onopen = () => {
        // 1. AUTH
        ws.send(JSON.stringify({ type: "auth", token }));
        // 2. Depois de autenticado, manda 'entrar'
        setTimeout(() => {
          ws.send(JSON.stringify({ action: "entrar" }));
          alert(`ğŸ® JOGADOR ${jogadorId} entrou na mesa ${mesaId}!`);
          ws.close();
          setTimeout(carregarMesa, 300);
        }, 250);
      };
      ws.onerror = (e) => alert("Erro WS entrar na mesa: " + e.message);
    }

    // Painel de espectador (recebe updates em tempo real da mesa)
    function conectarPainelWs(mesaId, token) {
      if (wsPainel && wsPainel.readyState === WebSocket.OPEN) {
        if (wsMesaId === mesaId) return;
        wsPainel.close();
      }
      wsMesaId = mesaId;
      wsPainel = new WebSocket(`ws://localhost:8000/ws/mesa/${mesaId}`);
      wsPainel.onopen = () => {
        wsPainel.send(JSON.stringify({ type: "auth", token }));
      };
      wsPainel.onmessage = (e) => {
        const data = JSON.parse(e.data);
        console.log("[WS][Painel]", data);

        // Atualiza painel quando receber evento relevante
        if (data.evento === "mesa_atualizada" || data.evento === "nova_rodada") {
          carregarMesa();
        }
      };
      wsPainel.onerror = (e) => console.error("[WS][Painel] erro", e);
      wsPainel.onclose = () => console.log("[WS][Painel] desconectado");
    }

    async function carregarMesa() {
      const mesaId = document.getElementById("mesaId").value;
      const token = tokens[1]; // Jogador 1 sÃ³ pra visualizar info

      // Sempre conecta (ou reusa) WS pra escutar updates
      conectarPainelWs(mesaId, token);

      try {
        const mesaRes = await fetch(`http://localhost:8000/mesa/${mesaId}`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const mesa = await mesaRes.json();

        const jogadoresRes = await fetch(`http://localhost:8000/mesa/${mesaId}/jogadores`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const jogadores = await jogadoresRes.json();

        document.getElementById("mesaInfo").innerHTML = `
          <h2>Mesa ${mesa.id} â€” Estado: ${mesa.estado_da_rodada}</h2>
          <p>Cartas comunitÃ¡rias: ${JSON.stringify(mesa.cartas_comunitarias)}</p>
          <p>Pote: R$ ${mesa.pote_total}</p>
          <p>Jogador da vez: ${mesa.jogador_da_vez}</p>
        `;

        const container = document.getElementById("jogadores");
        container.innerHTML = "";
        jogadores.forEach(j => {
          const vezTag = j.vez ? `<span class="vez">â— VEZ</span>` : "";
          const sbTag = j.is_sb ? "ğŸŸ¢ SB" : "";
          const bbTag = j.is_bb ? "ğŸ”´ BB" : "";
          const dealerTag = j.posicao_cadeira === mesa.dealer_pos ? "âšª DEALER" : "";

          const div = document.createElement("div");
          div.className = "jogador";
          div.innerHTML = `
            <h3>Jogador ${j.user_id} â€” posiÃ§Ã£o ${j.posicao_cadeira} ${vezTag}</h3>
            <p>Saldo atual: R$ ${j.saldo_atual}</p>
            <p>Aposta atual: R$ ${j.aposta_atual}</p>
            <p>Foldado: ${j.foldado}</p>
            <p>Agiu nesta rodada: ${j.rodada_ja_agiu}</p>
            <p>${sbTag} ${bbTag} ${dealerTag}</p>
            <p>Cartas: ${j.cartas?.join(", ")}</p>
            <button onclick="acaoPainelWs(${mesa.id}, ${j.user_id}, 'check')">Check</button>
            <button onclick="acaoPainelWs(${mesa.id}, ${j.user_id}, 'call')">Call</button>
            <button onclick="acaoPainelWs(${mesa.id}, ${j.user_id}, 'fold')">Fold</button>
            <button onclick="acaoPainelWs(${mesa.id}, ${j.user_id}, 'allin')">All-In</button>
            <br/>
            <label>Raise: R$ <input type="number" id="raise-${j.user_id}" value="0.05"/></label>
            <button onclick="acaoPainelWs(${mesa.id}, ${j.user_id}, 'raise', document.getElementById('raise-${j.user_id}').value)">Raise</button>
            <br/><br/>
            <button onclick="sairDaMesaWs(${mesa.id}, ${j.user_id})">ğŸšª Sair da Mesa</button>
            <button onclick="revelarCartas(${mesa.id}, ${j.user_id})">ğŸƒ Revelar Cartas</button>
          `;
          container.appendChild(div);
        });

      } catch (err) {
        console.error("ğŸ’¥ Erro ao carregar mesa:", err);
        alert("Erro: " + err.message);
      }
    }

    // WS pra mandar aÃ§Ã£o poker (igual o app)
    function acaoPainelWs(mesaId, jogadorId, tipo, valor = null) {
      const token = tokens[jogadorId];
      if (!token) {
        alert("Token nÃ£o encontrado!");
        return;
      }
      const ws = new WebSocket(`ws://localhost:8000/ws/mesa/${mesaId}`);
      ws.onopen = () => {
        ws.send(JSON.stringify({ type: "auth", token }));
        setTimeout(() => {
          const msg = { action: tipo };
          if (valor !== null) msg.valor = valor;
          ws.send(JSON.stringify(msg));
          ws.close();
        }, 200);
      };
    }

    function sairDaMesaWs(mesaId, jogadorId) {
      const token = tokens[jogadorId];
      if (!token) {
        alert("Token nÃ£o encontrado!");
        return;
      }
      const ws = new WebSocket(`ws://localhost:8000/ws/mesa/${mesaId}`);
      ws.onopen = () => {
        ws.send(JSON.stringify({ type: "auth", token }));
        setTimeout(() => {
          ws.send(JSON.stringify({ action: "sair" }));
          ws.close();
          setTimeout(carregarMesa, 300);
        }, 200);
      };
    }

    async function revelarCartas(mesaId, jogadorId) {
      const token = tokens[jogadorId];
      if (!token) {
        alert(`Token do jogador ${jogadorId} nÃ£o encontrado.`);
        return;
      }
      try {
        const res = await fetch(`http://localhost:8000/mesa/${mesaId}/revelar_cartas`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token
          }
        });
        const data = await res.json();
        alert(`ğŸƒ Jogador ${jogadorId} revelou suas cartas!\n${data.message || JSON.stringify(data)}`);
        carregarMesa();
      } catch (err) {
        console.error("Erro ao revelar cartas:", err);
        alert("Erro ao chamar /revelar_cartas: " + err.message);
      }
    }

    async function forcarShowdown() {
      const mesaId = document.getElementById("mesaId").value;
      const token = tokens[1];
      try {
        const res = await fetch(`http://localhost:8000/admin/${mesaId}/debug/forcar_showdown`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token
          }
        });
        const data = await res.json();
        alert(`ğŸ† Mesa ${mesaId} forÃ§ada para SHOWDOWN!\n${data.detail || "OK"}`);
        carregarMesa();
      } catch (err) {
        console.error("Erro ao forÃ§ar showdown:", err);
        alert("Erro ao chamar /debug/forcar_showdown: " + err.message);
      }
    }

    // Auto-carrega a mesa ao abrir o painel
    carregarMesa();
  </script>
</body>
</html>
